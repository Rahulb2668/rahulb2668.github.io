<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SMART RACK: Smart Rack Master software and Hardware documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="boxgifresized.gif"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SMART RACK
   &#160;<span id="projectnumber">V 1</span>
   </div>
   <div id="projectbrief">Smart Food Rack Master Documentation</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Smart Rack Master software and Hardware documentation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#Intro">Introduction</a></li>
<li class="level1"><a href="#mainHardware">Master Box hardware and software</a><ul><li class="level2"><a href="#addon">Additional Hardware</a></li>
</ul>
</li>
<li class="level1"><a href="#mainSoftware">Basic Work Flow</a><ul><li class="level2"><a href="#mode1">Idle Mode:</a></li>
<li class="level2"><a href="#mode2">Non Idle Mode:</a><ul><li class="level3"><a href="#usermode">User Mode(Unloading Mode):</a></li>
<li class="level3"><a href="#deliverymode">Delivery Mode(Loading Mode):</a></li>
</ul>
</li>
<li class="level2"><a href="#init">Initialization/restart:</a></li>
</ul>
</li>
<li class="level1"><a href="#Hardware">Hardware</a></li>
</ul>
</div>
<div class="textblock"><p>|<a class="el" href="nomenclature.html">Nomenclature</a>|<a class="el" href="codebrief.html">Code in brief</a>| </p>
<h1><a class="anchor" id="Intro"></a>
Introduction</h1>
<p>The SmartRack is a IOT enabled food containment device for B2C or B2B use developed by Agilebot Automation Pvt Ltd, Bangalore. The Rack consists of a 23 self contained slave units and a HMI. Stacked in a 4X6 fashion that have the ability to contain food packets/parcels.The master HMI box uses Raspbery PIi3 B+, lcd dsiplay for user interface. Each slave comes equipped with independent heating system and other hardware components to perform its basic functions.<br  />
 </p>
<h1><a class="anchor" id="mainHardware"></a>
Master Box hardware and software</h1>
<p>Master box is equipped with a touch screen, LCD display and keypad.Interaction with the rack is done via this master box. This box has raspberry pi 3B+ as the motherboard.This provides a graphical user interaction with the environment and the rack. Master will have multiple programs running.Gui, Keypad program, Serial Program , Mqtt communication will be the main program running continuously running in a continuous loop. <br  />
Functions or Programs Master have: <br  />
</p><ul>
<li>Mqtt and <a class="el" href="namespace_database.html">Database</a>: Collect all the packets of data from the broker and store it in a local Sql <a class="el" href="namespace_database.html">Database</a>. Periodically publish to certain topics in the broker</li>
<li>Keypad Program : Program to interface with Keypad</li>
<li>Serial (Rs485) : Program to communicate with slave box</li>
<li>GUI : program for user interface </li>
</ul>
<h2><a class="anchor" id="addon"></a>
Additional Hardware</h2>
<ul>
<li><em><b>Master Controller (Mispigy)</b></em>: <br  />
Master controller acts as a portal between the master pi and the slaves. Its purpose is to transfer data which are not corrupted to the master from the slave and vice versa. Master controller uses two serial ports USCI1 and USCI0. USCI0 is set up and used for communicating between the master controller and master pi. The USCI1 is used for communicating between the master controller and the slaves(RS485). The master pi sends packets of data to the master controller, the controller takes data and checks whether the data is corrupted by checking the LRC. If the data is valid , the master controller sends the data to the data bus. The same procedure is done when the data is received from the slave, the master controller checks if the response received from the slave is valid or not. If valid the data is sent to the master, if not the data is ignored.</li>
<li><em><b>RS485 Module</b></em>: <br  />
This module allows the converts UART to the RS485. Is generally used for industrial automation.The normal uart tx and rx is convereted to rs485 full dublex A,B,Y,Z.</li>
</ul>
<h1><a class="anchor" id="mainSoftware"></a>
Basic Work Flow</h1>
<p>For more info <a class="el" href="codebrief.html">Code in brief</a> <br  />
</p><div class="image">
<img src="workflow.png" alt=""/>
<div class="caption">
Work Flow Diagram</div></div>
<p>    <br  />
Basically the rack master has two modes</p><ol type="1">
<li><em><b>Idle Mode</b></em>: In this master deals with round robin of heaters and the mqtt communication'</li>
<li><em><b>Non Idle mode</b></em>: In this the master is either doing a unloading or loading operation of an order. <br  />
</li>
</ol>
<h2><a class="anchor" id="mode1"></a>
Idle Mode:</h2>
<p>In this mode the master is not doing any operation of loading or unloading.Master pings all the slave boxes in the rack which is loaded for its temperature. Only 5 boxes in the rack is allowed to have heaters on for safety purpose. Master calculates the difference of the temperature of the box and the tmeperature at which the food should be. Then it commands the first 5 boxes with higher difference to turn on and all other to turn off. This is repeated in a specifc time. At this master is ready to receive the order. </p>
<h2><a class="anchor" id="mode2"></a>
Non Idle Mode:</h2>
<p>There are 2 modes: </p>
<h3><a class="anchor" id="usermode"></a>
User Mode(Unloading Mode):</h3>
<ol type="1">
<li>User scans the rack Qr and orders the food on the website.</li>
<li>Broker assigns and publish ‘userotp’ topic with payload of a otp</li>
<li>Master stores the otp on the database subscribed from the topic(userotp)</li>
<li>When ‘usershowqrflag’ topic is published, master displays the qr (Message with otp) and publishes a topic ‘showinguserqr’</li>
<li>When ‘userqrverifiedflag’ is published, master gets all the data from the database for that otp.From the collected data box numbers and skuids are taken and loading mode commands for the boxes are sent and publishes ‘delivered’ topic for the respective slots</li>
</ol>
<h3><a class="anchor" id="deliverymode"></a>
Delivery Mode(Loading Mode):</h3>
<ol type="1">
<li>Same procedure like unloading mode</li>
</ol>
<dl class="section note"><dt>Note</dt><dd>Always the rack will be subscribed to the MQTT broker.</dd></dl>
<h2><a class="anchor" id="init"></a>
Initialization/restart:</h2>
<ol type="1">
<li>Master populates the local sql database by subscribing to all topics for a rack.</li>
<li>Master reconfigure Communication ID for all the slots. Each slot is having a unique ID.Master assigns a temporary communication of 1 byte for communication between master and slave.</li>
<li>Performs health check for all the boxes. (For 3 times if not responded declare as dead)</li>
<li>Send Configuration data</li>
<li>Querying individual boxes if the configuration data is successfully initialized in all individual boxes , if not again send the configuration data.</li>
</ol>
<h1><a class="anchor" id="Hardware"></a>
Hardware</h1>
<p>Master box consists of: <br  />
</p><ol type="1">
<li>Raspberry pi 3 B+ <a href="https://www.thingbits.in/products/raspberry-pi-4-model-b-2-gb-ram">Buy</a></li>
<li>7Inch Lcd display with Touch <a href="https://robu.in/product/7-inch-lcd-touch-display-with-driver-board-kit-for-raspberry-pi/">Buy</a></li>
<li>Mispigy (from Inscribe)</li>
<li>RS485 Module (from Inscribe)</li>
<li>Matrix Keypad <a href="https://robu.in/">Buy</a> </li>
</ol>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
